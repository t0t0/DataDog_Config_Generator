










server {
{{ range $key, $value := .}}
{{ $service := coalesce $value.Env.SERVICE ""}}
{{ if eq $service "nginx" }}
{{ $addrLen :=  len $value.Addresses}}
    {{/* If only 1 port exposed, use that */}}
    {{ if eq $addrLen 1 }}
       	{{ $address := index $value.Addresses 0 }}
       	{{ $port := $address.Port}}
    listen {{ $port}} ;
    {{/* If more than one port exposed, use the one matching VIRTPORT env var, falling back to standard web port 80 */}}
    {{ else }}
       	{{ $port := coalesce $value.Env.VIRTPORT "80" }}
	listen {{ $port}} ;
    {{ end }}
{{ end }}
{{ end }}  
	location /nginx_status {
          stub_status on;
          access_log off;
{{ range $key, $value := .}}
{{ $service := coalesce $value.Env.SERVICE ""}}
{{ if eq $service "datadog"}}
{{ $datadogaddress := $value.IP }}
 		  allow {{ $datadogaddress }};
{{ end }}
{{ end }}
          deny all;
        }
}